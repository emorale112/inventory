<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Sheets Search Web App</title>
  <style>
    /* Your existing CSS styles here */
    /* --- General Reset & Styling --- */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #F4F1F8; /* Soft off-white */
      color: #2e2e2e;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease;
      user-select: none;
      min-height: 100vh;
    }

    body.dark {
      background: #1B1731; /* Dark purple-gray */
      color: #dcd6f7;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(91, 62, 153, 0.2);
    }

    body.dark .container {
      background: rgba(44, 40, 71, 0.9);
    }

    h1 {
      font-weight: 700;
      font-size: 2.2em;
      margin-bottom: 30px;
      color: #4B2C67; /* Dark Plum */
      letter-spacing: 0.04em;
      text-align: center;
    }

    body.dark h1 {
      color: #A28FDB; /* Muted lavender */
    }

    .search-section {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(91, 62, 153, 0.1);
    }

    body.dark .search-section {
      background: rgba(44, 40, 71, 0.7);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95em;
      color: #5B3E99; /* Deep Purple */
    }

    body.dark label {
      color: #b0a9db;
    }

    /* --- Inputs & Selects --- */
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 11px 14px;
      border-radius: 10px;
      border: 1.5px solid #c7c0da;
      background: #fff;
      font-size: 1em;
      color: #2e2e2e;
      box-shadow: inset 0 1.5px 4px #e5e1f5;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      outline-offset: 2px;
      box-sizing: border-box;
    }

    input[type="text"]::placeholder,
    input[type="date"]::placeholder {
      color: #9a91be;
      font-style: italic;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: #7E57C2; /* Muted Lavender */
      box-shadow: 0 0 10px 2px #9a91be88;
      background: #f6f5fc;
      outline: none;
      color: #1c1c28;
    }

    body.dark input[type="text"],
    body.dark input[type="date"],
    body.dark select {
      background: #2c2847;
      border-color: #4B3C74;
      color: #d9d3f5;
      box-shadow: inset 0 1.5px 4px #3a3663;
    }

    body.dark input[type="text"]:focus,
    body.dark input[type="date"]:focus,
    body.dark select:focus {
      border-color: #a28fdb;
      box-shadow: 0 0 12px 3px #a28fdbcc;
      background: #3c3780;
      color: #f0efff;
    }

    /* --- Buttons --- */
    button {
      width: 100%;
      padding: 13px 0;
      margin-top: 22px;
      font-weight: 700;
      font-size: 1.15em;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #5B3E99, #7E57C2);
      color: white;
      box-shadow:
        0 6px 15px rgba(91, 62, 153, 0.5),
        inset 0 -3px 8px rgba(255, 255, 255, 0.25);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #4B2C67, #6A43B5);
      box-shadow:
        0 9px 22px rgba(75, 44, 103, 0.7),
        inset 0 -4px 12px rgba(255, 255, 255, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* --- Status message --- */
    .status {
      margin-top: 14px;
      font-size: 1em;
      font-weight: 600;
      color: #5B3E99;
      min-height: 26px;
      text-align: center;
      user-select: none;
    }

    body.dark .status {
      color: #a28fdb;
    }

    /* --- Download buttons container --- */
    .download-buttons {
      margin-top: 20px;
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .download-buttons button {
      background: linear-gradient(135deg, #8c7ddd, #5B3E99);
      box-shadow:
        0 4px 14px rgba(91, 62, 153, 0.6),
        inset 0 -2px 6px rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      font-weight: 700;
      font-size: 1em;
      padding: 10px 0;
      cursor: pointer;
      transition: background 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }

    .download-buttons button:hover {
      background: linear-gradient(135deg, #6A43B5, #4B2C67);
      box-shadow:
        0 6px 20px rgba(75, 44, 103, 0.8),
        inset 0 -3px 8px rgba(255, 255, 255, 0.5);
    }

    /* --- Dark mode toggle container --- */
    .toggle-container {
      margin-top: 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    /* --- Dark mode toggle switch --- */
    input#darkToggle {
      position: relative;
      width: 44px;
      height: 24px;
      appearance: none;
      background: #b8afd8;
      border-radius: 24px;
      outline: none;
      cursor: pointer;
      transition: background 0.3s ease;
      box-shadow:
        inset 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    input#darkToggle:checked {
      background: #5B3E99;
      box-shadow:
        0 0 8px #5B3E9988,
        inset 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    input#darkToggle::before {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      box-shadow:
        0 1px 4px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    input#darkToggle:checked::before {
      transform: translateX(20px);
    }

    /* --- Heart-shaped spinner --- */
    .loader {
      position: relative;
      width: 40px;
      height: 60px;
      animation: heartBeat 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
      margin: 22px auto 0;
      display: none;
    }

    .loader:before,
    .loader:after {
      content: "";
      width: 40px;
      height: 60px;
      border-radius: 50px 50px 0 0;
      position: absolute;
      left: 0;
      bottom: 0;
      transform-origin: 50% 68%;
      box-shadow: 5px 4px 6px #3a2a70 inset; /* Darker purple shadow */
    }

    .loader:before {
      background: #5B3E99; /* Deep Purple */
      transform: rotate(45deg);
      box-shadow: 5px 4px 6px #3a2a70 inset;
    }

    .loader:after {
      background: #7E57C2; /* Muted Lavender */
      transform: rotate(-45deg);
      box-shadow: 5px 4px 6px #5b479c inset;
    }

    @keyframes heartBeat {
      0% { transform: scale(0.95); }
      5% { transform: scale(1.1); }
      39% { transform: scale(0.85); }
      45% { transform: scale(1); }
      60% { transform: scale(0.95); }
      100% { transform: scale(0.9); }
    }

    /* --- Results section --- */
    .results-section {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 25px;
      margin-top: 25px;
      box-shadow: 0 5px 15px rgba(91, 62, 153, 0.1);
    }

    body.dark .results-section {
      background: rgba(44, 40, 71, 0.7);
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(91, 62, 153, 0.15);
    }

    body.dark .results-table {
      background: #2c2847;
    }

    .results-table th {
      background: linear-gradient(135deg, #5B3E99, #7E57C2);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    .results-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e1f5;
    }

    body.dark .results-table td {
      border-bottom-color: #4B3C74;
    }

    .results-table tr:nth-child(even) {
      background: #f6f3ff;
    }

    body.dark .results-table tr:nth-child(even) {
      background: #3c3780;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #9a91be;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Search Across Sheets</h1>

    <div class="search-section">
      <div class="form-row">
        <div>
          <label for="query">Search Term</label>
          <input type="text" id="query" placeholder="e.g. Pikachu, 123456" autocomplete="off" />
        </div>
        <div>
          <label for="column">Column</label>
          <select id="column" aria-label="Select column to search">
            <option value="all">All Columns</option>
            <option value="Item Name">Item Name</option>
            <option value="UPC">UPC</option>
            <option value="Quantity">Quantity</option>
            <option value="Received Date">Received Date</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="sheet">Sheet</label>
          <select id="sheet" aria-label="Select sheet to search">
            <option value="all">All Sheets</option>
          </select>
        </div>
        <div>
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" placeholder="MM/DD/YYYY" />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" placeholder="MM/DD/YYYY" />
        </div>
        <div>
          <!-- Empty div for grid alignment -->
        </div>
      </div>

      <button onclick="runSearch()" id="searchBtn" aria-live="polite">Search</button>

      <div class="loader" id="spinner" role="status" aria-live="polite" aria-label="Loading"></div>

      <div class="status" id="status" aria-live="polite">Ready</div>

      <div class="download-buttons" id="downloadButtons" aria-live="polite" role="region" aria-label="Download search results">
        <button onclick="downloadResults('csv')">Download CSV</button>
        <button onclick="downloadResults('json')">Download JSON</button>
      </div>
    </div>

    <div class="results-section" id="resultsSection" style="display: none;">
      <h2>Search Results</h2>
      <div id="results"></div>
    </div>

    <div class="toggle-container">
      <label for="darkToggle">Dark Mode</label>
      <input type="checkbox" id="darkToggle" onchange="toggleDarkMode()" aria-checked="false" role="switch" />
    </div>
  </div>

  <script>
    // Replace with your deployed Apps Script Web App URL
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzxCgx7BuJ4v6fqOoCPVbWglLZ5e0eF6shzPJNRqvMHzQ9znYvK5QKsyjNGWi0Zp0IIsw/exec';

    function runSearch() {
      const query = document.getElementById('query').value.trim();
      const column = document.getElementById('column').value;
      const sheet = document.getElementById('sheet').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const status = document.getElementById('status');
      const spinner = document.getElementById('spinner');
      const button = document.getElementById('searchBtn');
      const resultsSection = document.getElementById('resultsSection');
      const resultsDiv = document.getElementById('results');

      if (!query) {
        status.textContent = 'Please enter a search term.';
        return;
      }

      status.textContent = 'Searching...';
      spinner.style.display = 'block';
      button.disabled = true;
      resultsSection.style.display = 'none';

      // Build query parameters
      const params = new URLSearchParams({
        action: 'search',
        query: query,
        column: column,
        sheet: sheet,
        startDate: startDate,
        endDate: endDate
      });

      fetch(`${APPS_SCRIPT_URL}?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          spinner.style.display = 'none';
          button.disabled = false;
          
          if (data.success) {
            status.textContent = `Found ${data.results.length} matching row(s).`;
            displayResults(data.results);
            const downloadButtons = document.getElementById('downloadButtons');
            downloadButtons.style.display = data.results.length > 0 ? 'flex' : 'none';
          } else {
            status.textContent = 'Error: ' + data.error;
          }
        })
        .catch(err => {
          spinner.style.display = 'none';
          button.disabled = false;
          status.textContent = 'Error: ' + err.message;
        });
    }

    function displayResults(results) {
      const resultsSection = document.getElementById('resultsSection');
      const resultsDiv = document.getElementById('results');
      
      if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No results found.</div>';
      } else {
        let html = '<table class="results-table"><thead><tr>';
        html += ['Sheet', 'Item Name', 'UPC', 'Quantity', 'Received Date'].map(h => `<th>${h}</th>`).join('');
        html += '</tr></thead><tbody>';
        
        results.forEach(row => {
          html += '<tr>' + row.map(cell => `<td>${cell || ''}</td>`).join('') + '</tr>';
        });
        
        html += '</tbody></table>';
        resultsDiv.innerHTML = html;
      }
      
      resultsSection.style.display = 'block';
    }

    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark');
      const toggle = document.getElementById('darkToggle');
      toggle.setAttribute('aria-checked', body.classList.contains('dark'));
    }

    function downloadResults(type) {
      // This would need to be implemented in your Apps Script backend
      // For now, we'll just show a message
      alert(`Download ${type.toUpperCase()} functionality needs to be implemented in the Apps Script backend.`);
    }

    // Event listeners
    document.getElementById('query').addEventListener('keydown', e => {
      if (e.key === 'Enter') runSearch();
    });

    window.onload = () => {
      document.getElementById('query').focus();
    };
  </script>
</body>
</html>
