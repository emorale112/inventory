<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory Search</title>

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f1ff;
    color: #2f2451;
    margin: 0; padding: 20px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }
  h1 {
    color: #4B3B94;
    text-align: center;
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
  }
  select, input[type="text"], input[type="date"] {
    width: 100%;
    padding: 8px 10px;
    font-size: 1em;
    border: 1.8px solid #a59be6;
    border-radius: 6px;
    outline-offset: 2px;
    outline-color: #8578ff;
    transition: outline-color 0.3s ease;
  }
  select:focus, input[type="text"]:focus, input[type="date"]:focus {
    outline-color: #4b3b94;
  }
  button {
    margin-top: 20px;
    width: 100%;
    background-color: #4B3B94;
    border: none;
    color: white;
    padding: 12px;
    font-size: 1.1em;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #6b59e8;
  }
  button:disabled {
    background-color: #b6b1dd;
    cursor: not-allowed;
  }
  #status {
    margin-top: 15px;
    min-height: 24px;
    font-weight: 600;
    color: #4B3B94;
    text-align: center;
  }
  table {
    margin-top: 20px;
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9em;
  }
  th, td {
    border: 1px solid #d6d0ff;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #6b59e8;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f1eefa;
  }
  .spinner {
    margin: 20px auto;
    display: none;
    width: 48px;
    height: 72px;
    position: relative;
    animation: heartBeat 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
  }
  .spinner:before,
  .spinner:after {
    content: "";
    background: #4B3B94;
    width: 48px;
    height: 72px;
    border-radius: 50px 50px 0 0;
    position: absolute;
    left: 0;
    bottom: 0;
    transform-origin: 50% 68%;
    box-shadow: 5px 4px 5px #0004 inset;
  }
  .spinner:before {
    transform: rotate(45deg);
  }
  .spinner:after {
    transform: rotate(-45deg);
  }
  @keyframes heartBeat {
    0% { transform: scale(0.95) }
    5% { transform: scale(1.1) }
    39% { transform: scale(0.85) }
    45% { transform: scale(1) }
    60% { transform: scale(0.95) }
    100% { transform: scale(0.9) }
  }
  .download-email-container {
    margin-top: 15px;
    display: flex;
    gap: 10px;
  }
  .download-email-container button, .download-email-container input[type="email"] {
    flex: 1;
  }
  input[type="email"] {
    padding: 8px 10px;
    font-size: 1em;
    border: 1.8px solid #a59be6;
    border-radius: 6px;
    outline-offset: 2px;
    outline-color: #8578ff;
    transition: outline-color 0.3s ease;
  }
</style>

</head>
<body>

<h1>Inventory Search</h1>

<label for="query">Search Term</label>
<input type="text" id="query" placeholder="e.g. Pikachu, 123456" />

<label for="column">Column</label>
<select id="column">
  <option value="all">All Columns</option>
  <option value="item name">Item Name</option>
  <option value="upc">UPC</option>
  <option value="quantity">Quantity</option>
  <option value="received date">Received Date</option>
</select>

<label for="sheet">Sheet</label>
<select id="sheet">
  <option value="all">All Sheets</option>
</select>

<label for="startDate">Start Date</label>
<input type="date" id="startDate" />

<label for="endDate">End Date</label>
<input type="date" id="endDate" />

<button id="searchBtn">Search</button>
<div class="spinner" id="spinner"></div>
<div id="status">Ready</div>

<div class="download-email-container" style="display:none;" id="actionsContainer">
  <button id="downloadCsvBtn">Download CSV</button>
  <button id="downloadJsonBtn">Download JSON</button>
  <input type="email" id="emailInput" placeholder="Email address to send results" />
  <button id="emailBtn">Email Results</button>
</div>

<table id="resultsTable" style="display:none;">
  <thead>
    <tr>
      <th>Box Location</th>
      <th>Item Name</th>
      <th>UPC</th>
      <th>Quantity</th>
      <th>Received Date</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxplszX0XuAQKRsutvmzcmU5ACI3nVaE6cwQamXxvZc2d14Ug2uHM3PmrkrJNJBdVj1Bw/exec'; // <-- Replace with your Apps Script Web App URL

  const queryInput = document.getElementById('query');
  const columnSelect = document.getElementById('column');
  const sheetSelect = document.getElementById('sheet');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const searchBtn = document.getElementById('searchBtn');
  const spinner = document.getElementById('spinner');
  const status = document.getElementById('status');
  const resultsTable = document.getElementById('resultsTable');
  const resultsBody = resultsTable.querySelector('tbody');
  const actionsContainer = document.getElementById('actionsContainer');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const downloadJsonBtn = document.getElementById('downloadJsonBtn');
  const emailInput = document.getElementById('emailInput');
  const emailBtn = document.getElementById('emailBtn');

  // Load sheet names on page load
  window.onload = () => {
    fetch(WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ action: 'getSheetNames' })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success && Array.isArray(data.names)) {
        data.names.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sheetSelect.appendChild(opt);
        });
      }
    })
    .catch(() => {
      status.textContent = 'Failed to load sheet names.';
    });
  };

  searchBtn.onclick = () => {
    const query = queryInput.value.trim();
    if (!query) {
      status.textContent = 'Please enter a search term.';
      return;
    }
    status.textContent = '';
    resultsBody.innerHTML = '';
    resultsTable.style.display = 'none';
    actionsContainer.style.display = 'none';
    spinner.style.display = 'block';
    searchBtn.disabled = true;

    const postData = {
      action: 'search',
      query,
      column: columnSelect.value,
      sheet: sheetSelect.value,
      startDate: startDateInput.value,
      endDate: endDateInput.value
    };

    fetch(WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(postData)
    })
    .then(r => r.json())
    .then(data => {
      spinner.style.display = 'none';
      searchBtn.disabled = false;
      if (data.success) {
        const results = data.results;
        if (!results.length) {
          status.textContent = 'No matching rows found.';
          return;
        }
        status.textContent = `Found ${results.length} matching row(s).`;
        renderResults(results);
        actionsContainer.style.display = 'flex';
      } else {
        status.textContent = 'Error: ' + data.error;
      }
    })
    .catch(err => {
      spinner.style.display = 'none';
      searchBtn.disabled = false;
      status.textContent = 'Error: ' + err.message;
    });
  };

  function renderResults(results) {
    resultsBody.innerHTML = '';
    results.forEach(row => {
      const tr = document.createElement('tr');
      row.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      resultsBody.appendChild(tr);
    });
    resultsTable.style.display = 'table';
  }

  // CSV conversion helper
  function arrayToCSV(rows) {
    const header = ['Box Location', 'Item Name', 'UPC', 'Quantity', 'Received Date'];
    const csvRows = [header.join(',')];
    rows.forEach(r => {
      const escaped = r.map(cell => `"${String(cell).replace(/"/g, '""')}"`);
      csvRows.push(escaped.join(','));
    });
    return csvRows.join('\r\n');
  }

  downloadCsvBtn.onclick = () => {
    const rows = [...resultsBody.querySelectorAll('tr')].map(tr =>
      [...tr.children].map(td => td.textContent)
    );
    const csv = arrayToCSV(rows);
    downloadFile(csv, 'search_results.csv', 'text/csv');
  };

  downloadJsonBtn.onclick = () => {
    const rows = [...resultsBody.querySelectorAll('tr')].map(tr =>
      [...tr.children].map(td => td.textContent)
    );
    const json = JSON.stringify(rows, null, 2);
    downloadFile(json, 'search_results.json', 'application/json');
  };

  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  emailBtn.onclick = () => {
    const email = emailInput.value.trim();
    if (!email) {
      alert('Please enter an email address.');
      return;
    }
    const rows = [...resultsBody.querySelectorAll('tr')].map(tr =>
      [...tr.children].map(td => td.textContent)
    );
    const csv = arrayToCSV(rows);

    status.textContent = 'Sending email...';
    emailBtn.disabled = true;

    fetch(WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        action: 'emailResults',
        email,
        csv
      })
    })
    .then(r => r.json())
    .then(data => {
      emailBtn.disabled = false;
      if (data.success) {
        status.textContent = 'Email sent successfully!';
      } else {
        status.textContent = 'Error sending email: ' + data.error;
      }
    })
    .catch(err => {
      emailBtn.disabled = false;
      status.textContent = 'Error sending email: ' + err.message;
    });
  };

  // Optional: Trigger search on Enter key in search input
  queryInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') searchBtn.click();
  });
</script>

</body>
</html>
