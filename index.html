<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory Search</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 16px;
    background-color: #f0edf7;
    color: #222;
    max-width: 480px;
    margin: 20px auto;
  }
  label {
    display: block;
    margin-top: 12px;
    font-weight: 600;
  }
  input, select, button {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    border-radius: 6px;
    border: 1px solid #8b80b4;
    box-sizing: border-box;
    font-size: 1em;
  }
  button {
    background-color: #5b4b8a;
    color: white;
    font-weight: bold;
    margin-top: 14px;
    cursor: pointer;
    user-select: none;
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .spinner {
    margin: 16px auto;
    border: 4px solid #c2bedf;
    border-top: 4px solid #5b4b8a;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    animation: spin 1s linear infinite;
    display: none;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .status {
    margin-top: 12px;
    min-height: 24px;
    color: #5b4b8a;
  }
  .download-buttons {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .download-buttons button {
    flex: 1 1 48%;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    font-size: 0.9em;
  }
  th {
    background: #5b4b8a;
    color: white;
  }
  tr:nth-child(even) {
    background: #f7f5fc;
  }
</style>
</head>
<body>

<h1>Inventory Search</h1>

<label for="query">Search Term</label>
<input id="query" placeholder="e.g. Pikachu, 123456" />

<label for="column">Column</label>
<select id="column">
  <option value="all">All Columns</option>
  <option value="Item Name">Item Name</option>
  <option value="UPC">UPC</option>
  <option value="Quantity">Quantity</option>
  <option value="Received Date">Received Date</option>
</select>

<label for="sheet">Sheet</label>
<select id="sheet"><option value="all">All Sheets</option></select>

<label for="startDate">Start Date</label>
<input type="date" id="startDate" />

<label for="endDate">End Date</label>
<input type="date" id="endDate" />

<button id="searchBtn" onclick="runSearch()">Search</button>

<div class="spinner" id="spinner"></div>
<div class="status" id="status">Ready</div>

<div class="download-buttons" id="downloadButtons" style="display:none;">
  <button onclick="downloadCSV()">Download CSV</button>
  <button onclick="downloadJSON()">Download JSON</button>
</div>

<table id="resultsTable" style="display:none;">
  <thead>
    <tr>
      <th>Box Location</th>
      <th>Item Name</th>
      <th>UPC</th>
      <th>Quantity</th>
      <th>Received Date</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxplszX0XuAQKRsutvmzcmU5ACI3nVaE6cwQamXxvZc2d14Ug2uHM3PmrkrJNJBdVj1Bw/exec'; // <-- Replace with your actual Web App URL

let lastResults = [];

async function fetchSheetNames() {
  const res = await fetch(`${WEBAPP_URL}?action=getSheetNames`);
  const data = await res.json();
  if (data.success) {
    const sheetSelect = document.getElementById('sheet');
    data.sheets.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sheetSelect.appendChild(opt);
    });
  }
}

async function runSearch() {
  const query = document.getElementById('query').value.trim();
  const column = document.getElementById('column').value;
  const sheet = document.getElementById('sheet').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const status = document.getElementById('status');
  const spinner = document.getElementById('spinner');
  const searchBtn = document.getElementById('searchBtn');
  const resultsTable = document.getElementById('resultsTable');
  const tbody = resultsTable.querySelector('tbody');

  if (!query) {
    status.textContent = 'Please enter a search term.';
    return;
  }

  status.textContent = 'Searching...';
  spinner.style.display = 'block';
  searchBtn.disabled = true;
  resultsTable.style.display = 'none';
  tbody.innerHTML = '';
  document.getElementById('downloadButtons').style.display = 'none';

  try {
    const params = new URLSearchParams({
      action: 'searchSheetsWithFilters',
      query,
      column,
      sheet,
      startDate,
      endDate
    });

    const res = await fetch(`${WEBAPP_URL}?${params.toString()}`);
    const data = await res.json();

    spinner.style.display = 'none';
    searchBtn.disabled = false;

    if (data.success) {
      lastResults = data.results;

      if (lastResults.length === 0) {
        status.textContent = 'No matching rows found.';
        return;
      }

      status.textContent = `Found ${lastResults.length} matching row(s).`;

      // Populate table
      lastResults.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      resultsTable.style.display = 'table';
      document.getElementById('downloadButtons').style.display = 'flex';
    } else {
      status.textContent = 'Error: ' + data.error;
    }
  } catch (err) {
    spinner.style.display = 'none';
    searchBtn.disabled = false;
    status.textContent = 'Fetch error: ' + err.message;
  }
}

function downloadCSV() {
  if (!lastResults.length) {
    alert('No results to download.');
    return;
  }
  const headers = ['Box Location', 'Item Name', 'UPC', 'Quantity', 'Received Date'];
  const csvRows = [headers.join(',')];
  lastResults.forEach(row => {
    const escaped = row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`);
    csvRows.push(escaped.join(','));
  });
  const csvString = csvRows.join('\n');
  const blob = new Blob([csvString], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'search_results.csv';
  a.click();

  URL.revokeObjectURL(url);
}

function downloadJSON() {
  if (!lastResults.length) {
    alert('No results to download.');
    return;
  }
  const headers = ['Box Location', 'Item Name', 'UPC', 'Quantity', 'Received Date'];
  const jsonArray = lastResults.map(row => {
    const obj = {};
    headers.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });

  const jsonString = JSON.stringify(jsonArray, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'search_results.json';
  a.click();

  URL.revokeObjectURL(url);
}

// Load sheet names on page load
window.onload = fetchSheetNames;
</script>

</body>
</html>
