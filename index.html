<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Container width smaller for less wide sidebar */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #2e1a47;
      color: #e0dff4;
      padding: 12px 18px;
      max-width: 320px;
      margin: 0 auto;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background-color: #1a1032;
      color: #cfc9f7;
    }

    h2 {
      color: #a392d1;
      margin-bottom: 14px;
      font-weight: 600;
      text-align: center;
      user-select: none;
    }

    label {
      display: block;
      margin: 12px 0 6px 0;
      font-weight: 600;
      font-size: 0.9rem;
      user-select: none;
    }

    input[type="text"],
    select,
    input[type="date"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      outline: none;
      background-color: #433a65;
      color: #e0dff4;
      transition: background-color 0.3s ease;
      box-sizing: border-box;
    }
    input[type="text"]::placeholder {
      color: #b7aee0;
    }
    input[type="text"]:focus,
    select:focus,
    input[type="date"]:focus {
      background-color: #5a4e8c;
      box-shadow: 0 0 8px #a08cf7;
    }

    button {
      margin-top: 16px;
      width: 100%;
      background-color: #8c79d4;
      border: none;
      padding: 10px;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #a08cf7;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Pulsing heart spinner matching purple theme */
    #spinner {
      display: none;
      margin: 20px auto 0;
      width: 40px;
      height: 60px;
      position: relative;
      animation: heartBeat 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
    }
    #spinner:before,
    #spinner:after {
      content: "";
      background: #a08cf7;
      width: 40px;
      height: 60px;
      border-radius: 50px 50px 0 0;
      position: absolute;
      left: 0;
      bottom: 0;
      transform-origin: 50% 68%;
      box-shadow: 5px 4px 5px #4a4280 inset;
    }
    #spinner:before {
      transform: rotate(45deg);
    }
    #spinner:after {
      transform: rotate(-45deg);
    }
    @keyframes heartBeat {
      0% { transform: scale(0.95) }
      5% { transform: scale(1.1) }
      39% { transform: scale(0.85) }
      45% { transform: scale(1) }
      60% { transform: scale(0.95) }
      100% { transform: scale(0.9) }
    }

    .status {
      margin-top: 14px;
      font-size: 0.95rem;
      text-align: center;
      min-height: 24px;
      color: #c0bbee;
      user-select: none;
    }

    /* Search area container for collapsing */
    #searchArea {
      overflow: hidden;
      transition: height 0.5s ease, opacity 0.5s ease;
    }

    /* Table for results */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      font-size: 0.9rem;
      color: #f0eefe;
      user-select: text;
    }
    table thead {
      background-color: #7f74c7;
      font-weight: 700;
      text-align: left;
    }
    table thead th {
      padding: 8px 12px;
      border-bottom: 2px solid #5e569a;
    }
    table tbody tr:nth-child(even) {
      background-color: #3a2c6f;
    }
    table tbody tr:nth-child(odd) {
      background-color: #4b3b85;
    }
    table tbody td {
      padding: 6px 12px;
      border-bottom: 1px solid #5e569a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 110px;
    }

    /* Controls for dark mode toggle */
    .toggle-container {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      user-select: none;
    }
    .toggle-container label {
      font-size: 0.9rem;
    }
    .toggle-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Download and email buttons container */
    #downloadButtons {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    #downloadButtons button {
      width: auto;
      flex: 1;
      padding: 8px 12px;
      background-color: #a08cf7;
      font-size: 0.9rem;
      border-radius: 6px;
    }
    #downloadButtons button:hover {
      background-color: #b5a9f9;
    }
    #clearBtn {
      margin-top: 12px;
      width: 100%;
      background-color: #6c5bb8;
      font-size: 0.9rem;
      border-radius: 6px;
    }
    #clearBtn:hover {
      background-color: #7d6dcf;
    }
  </style>
</head>
<body>
  <h2>Search Across Sheets</h2>

  <div id="searchArea">
    <label for="query">Search Term</label>
    <input type="text" id="query" placeholder="e.g. Pikachu, 123456" />

    <label for="column">Column</label>
    <select id="column">
      <option value="all">All Columns</option>
      <option value="Item Name">Item Name</option>
      <option value="UPC">UPC</option>
      <option value="Quantity">Quantity</option>
      <option value="Received Date">Received Date</option>
    </select>

    <label for="sheet">Sheet</label>
    <select id="sheet">
      <option value="all">All Sheets</option>
    </select>

    <label for="startDate">Start Date</label>
    <input type="date" id="startDate" />

    <label for="endDate">End Date</label>
    <input type="date" id="endDate" />

    <button id="searchBtn" onclick="runSearch()">Search</button>
  </div>

  <div id="spinner"></div>
  <div class="status" id="status">Ready</div>

  <div id="downloadButtons" style="display:none;">
    <button onclick="downloadResults('csv')">Download CSV</button>
    <button onclick="downloadResults('json')">Download JSON</button>
    <button onclick="emailResults()">Email Results</button>
  </div>
  <button id="clearBtn" style="display:none;" onclick="clearSearch()">Clear Search</button>

  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>Box Location</th>
        <th>Item Name</th>
        <th>UPC</th>
        <th>Quantity</th>
        <th>Received Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="toggle-container">
    <label for="darkToggle">Dark Mode</label>
    <input type="checkbox" id="darkToggle" onchange="toggleDarkMode()" />
  </div>

  <script>
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxplszX0XuAQKRsutvmzcmU5ACI3nVaE6cwQamXxvZc2d14Ug2uHM3PmrkrJNJBdVj1Bw/exec'; // Replace with your Apps Script Web App URL
    let lastResults = [];

    // Populate sheets dropdown
    google.script.run.withSuccessHandler(sheets => {
      const select = document.getElementById('sheet');
      sheets.forEach(name => {
        if (name === 'Search Results') return;
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }).getSheetNames();

    function runSearch() {
      const query = document.getElementById('query').value.trim();
      const column = document.getElementById('column').value;
      const sheet = document.getElementById('sheet').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const status = document.getElementById('status');
      const spinner = document.getElementById('spinner');
      const button = document.getElementById('searchBtn');

      if (!query) {
        status.textContent = 'Please enter a search term.';
        return;
      }

      status.textContent = 'Searching...';
      spinner.style.display = 'block';
      button.disabled = true;
      document.getElementById('clearBtn').style.display = 'none';
      document.getElementById('downloadButtons').style.display = 'none';
      document.getElementById('resultsTable').style.display = 'none';

      google.script.run.withSuccessHandler(function(results) {
        spinner.style.display = 'none';
        button.disabled = false;

        if (!results || results.length === 0) {
          status.textContent = 'No matching rows found.';
          lastResults = [];
          return;
        }

        status.textContent = `Found ${results.length} matching row(s).`;
        lastResults = results;
        showResultsTable(results);
        collapseSearchArea();
        document.getElementById('downloadButtons').style.display = 'flex';
        document.getElementById('clearBtn').style.display = 'block';

      }).withFailureHandler(function(error) {
        spinner.style.display = 'none';
        button.disabled = false;
        status.textContent = 'Error during search: ' + error.message;
      }).searchSheets(query, column, sheet, startDate, endDate);
    }

    function showResultsTable(results) {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      results.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      document.getElementById('resultsTable').style.display = 'table';
    }

    function collapseSearchArea() {
      const searchArea = document.getElementById('searchArea');
      searchArea.style.transition = 'height 0.5s ease, opacity 0.5s ease';
      searchArea.style.height = searchArea.scrollHeight + 'px';
      requestAnimationFrame(() => {
        searchArea.style.height = '0';
        searchArea.style.opacity = '0';
      });
      setTimeout(() => {
        searchArea.style.display = 'none';
      }, 500);
    }

    function expandSearchArea() {
      const searchArea = document.getElementById('searchArea');
      searchArea.style.display = 'block';
      searchArea.style.opacity = '0';
      searchArea.style.height = '0';
      requestAnimationFrame(() => {
        searchArea.style.transition = 'height 0.5s ease, opacity 0.5s ease';
        searchArea.style.height = searchArea.scrollHeight + 'px';
        searchArea.style.opacity = '1';
      });
      setTimeout(() => {
        searchArea.style.height = '';
        searchArea.style.transition = '';
      }, 500);
    }

    function clearSearch() {
      lastResults = [];
      document.getElementById('status').textContent = 'Ready';
      document.getElementById('downloadButtons').style.display = 'none';
      document.getElementById('resultsTable').style.display = 'none';
      document.getElementById('clearBtn').style.display = 'none';
      document.getElementById('query').value = '';
      document.getElementById('column').value = 'all';
      document.getElementById('sheet').value = 'all';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      expandSearchArea();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function downloadResults(type) {
      if (!lastResults.length) {
        alert('No results to download.');
        return;
      }

      if (type === 'csv') {
        const headers = ['Box Location', 'Item Name', 'UPC', 'Quantity', 'Received Date'];
        const csvRows = [headers.join(',')];
        lastResults.forEach(row => {
          const escaped = row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`);
          csvRows.push(escaped.join(','));
        });
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'search_results.csv';
        a.click();
        URL.revokeObjectURL(url);
      } else if (type === 'json') {
        const jsonStr = JSON.stringify(lastResults, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'search_results.json';
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    function emailResults() {
      if (!lastResults.length) {
        alert('No results to email.');
        return;
      }
      const email = prompt('Enter email address to send results to:');
      if (!email) return;

      const headers = ['Box Location', 'Item Name', 'UPC', 'Quantity', 'Received Date'];
      const csvRows = [headers.join(',')];
      lastResults.forEach(row => {
        const escaped = row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`);
        csvRows.push(escaped.join(','));
      });
      const csvString = csvRows.join('\n');

      fetch(WEBAPP_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'emailResults',
          email,
          csv: csvString
        }),
        headers: { 'Content-Type': 'application/json' }
      }).then(res => res.json())
        .then(data => {
          if (data.success) alert('Email sent!');
          else alert('Error sending email: ' + data.error);
        })
        .catch(e => alert('Fetch error: ' + e.message));
    }

    // Run search on Enter key press
    document.getElementById('query').addEventListener('keydown', e => {
      if (e.key === 'Enter') runSearch();
    });
  </script>
</body>
</html>
